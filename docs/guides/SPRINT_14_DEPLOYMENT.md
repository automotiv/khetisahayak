# Sprint 14 Deployment Guide - Kheti Sahayak

**Last Updated:** January 12, 2026

This guide covers deployment of Sprint 12-13 features including social login, weather alerts, mandi prices, and AI diagnostics.

---

## What's New in Sprint 12-13

### Backend Features
- Google/Facebook OAuth social login
- Sentry error monitoring
- Expert consultation with Agora video calls
- Weather alerts system (9 alert types)
- Multilingual diagnostics (7 languages)
- Interactive learning modules
- Government schemes integration (20 schemes)
- LLaVA AI diagnostics with fallback chain
- Real weather API (OpenWeatherMap + IMD + Open-Meteo)
- Mandi prices API (MSP comparison, price alerts)
- Village-level forecasts (21 states crop calendar)

### Flutter Features
- Google Sign-In / Facebook Sign-In
- Sentry error monitoring
- Learning modules with quizzes
- Localized diagnostic results
- Weather alert notifications

---

## Prerequisites

- Render.com account (free tier works)
- Vercel account (for frontend)
- GitHub repository connected
- API keys for external services (see below)

---

## Step 1: Prepare Environment Variables

### Required API Keys to Obtain

| Service | Get Key From | Purpose |
|---------|--------------|---------|
| OpenWeatherMap | https://openweathermap.org/api | Weather data |
| data.gov.in | https://data.gov.in/user/register | IMD weather data |
| Google OAuth | https://console.cloud.google.com | Social login |
| Facebook OAuth | https://developers.facebook.com | Social login |
| Sentry | https://sentry.io | Error monitoring |
| Agora | https://console.agora.io | Video calls |
| Razorpay | https://dashboard.razorpay.com | Payments |
| Firebase | https://console.firebase.google.com | Push notifications |

### Render Environment Variables

Configure these in Render Dashboard > Environment:

```env
# ===========================================
# REQUIRED - Backend will fail without these
# ===========================================

# JWT (auto-generated by Render blueprint)
JWT_SECRET=<auto-generated>
JWT_EXPIRES_IN=7d

# Database (auto-configured by Render)
DATABASE_URL=<from-render-postgres>

# ===========================================
# RECOMMENDED - Core functionality
# ===========================================

# Weather APIs (get from openweathermap.org)
OPENWEATHER_API_KEY=your_key_here

# Sentry Error Monitoring (get from sentry.io)
SENTRY_DSN=https://xxx@sentry.io/xxx

# ===========================================
# OPTIONAL - Enhanced features
# ===========================================

# Google OAuth (get from Google Cloud Console)
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_ID_IOS=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_ID_ANDROID=xxx.apps.googleusercontent.com

# Facebook OAuth (get from Facebook Developers)
FACEBOOK_APP_ID=your_app_id
FACEBOOK_APP_SECRET=your_app_secret

# Agora Video Calls (get from agora.io)
AGORA_APP_ID=your_agora_app_id
AGORA_APP_CERTIFICATE=your_agora_certificate

# LLaVA AI Service (if running separately)
LLAVA_API_URL=http://your-llava-service:8001
LLAVA_TIMEOUT_MS=60000

# data.gov.in API (for IMD weather)
DATA_GOV_API_KEY=your_data_gov_key

# SMS Provider (for weather alerts)
SMS_PROVIDER=console
MSG91_AUTH_KEY=your_msg91_key
MSG91_SENDER_ID=KHETI

# Email (for notifications)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
```

---

## Step 2: Deploy to Render

### Option A: Blueprint Deployment (Recommended)

1. Go to https://dashboard.render.com
2. Click "New" > "Blueprint"
3. Connect your GitHub repository
4. Render will detect `render.yaml` and configure:
   - PostgreSQL database (free tier)
   - Backend web service
5. Click "Apply"
6. Add environment variables in Render dashboard

### Option B: Manual Deployment

1. Create PostgreSQL database:
   - Render Dashboard > New > PostgreSQL
   - Name: `kheti-sahayak-db`
   - Region: Singapore
   - Plan: Free

2. Create Web Service:
   - Render Dashboard > New > Web Service
   - Connect GitHub repo
   - Root Directory: `kheti_sahayak_backend`
   - Build Command: `npm install && npm run migrate:up`
   - Start Command: `npm start`
   - Add environment variables

---

## Step 3: Database Initialization

Migrations run automatically on deploy via build command.

To seed data, SSH into Render or use Render Shell:

```bash
# Run schemes seed (20 government schemes)
npm run db:seed:schemes

# General seed (includes MSP data)
npm run db:seed
```

Or seeds run automatically on first deploy if no admin user exists.

---

## Step 4: Deploy Frontend to Vercel

1. Go to https://vercel.com
2. Import GitHub repository
3. Root Directory: `frontend`
4. Framework: Vite
5. Add environment variable:
   ```
   VITE_API_URL=https://your-render-backend.onrender.com/api
   ```
6. Deploy

---

## Step 5: Configure Flutter App

### Update API Base URL

Edit `kheti_sahayak_app/lib/.env`:

```env
API_BASE_URL=https://your-render-backend.onrender.com/api
SENTRY_DSN=your_sentry_dsn
RAZORPAY_KEY_ID=your_razorpay_key
AGORA_APP_ID=your_agora_app_id
```

### Build APK

```bash
cd kheti_sahayak_app

# Get dependencies
flutter pub get

# Build release APK
flutter build apk --release

# Build App Bundle (for Play Store)
flutter build appbundle --release
```

APK location: `build/app/outputs/flutter-apk/app-release.apk`

---

## Step 6: Verify Deployment

### Health Check

```bash
curl https://your-backend.onrender.com/api/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2026-01-12T14:30:00.000Z",
  "database": "connected"
}
```

### Test New Endpoints

```bash
# Weather alerts types
curl https://your-backend.onrender.com/api/weather-alerts/types

# Village search
curl "https://your-backend.onrender.com/api/village-weather/search?q=Nashik"

# Government schemes
curl https://your-backend.onrender.com/api/schemes

# Mandi prices
curl https://your-backend.onrender.com/api/market-prices/msp
```

---

## New API Endpoints Reference

### Weather Alerts (`/api/weather-alerts`)
- `GET /types` - Available alert types
- `GET /check?lat=&lon=` - Check alerts for location
- `GET /preferences` - User preferences (auth)
- `PUT /preferences` - Update preferences (auth)
- `GET /subscriptions` - Location subscriptions (auth)
- `POST /subscriptions` - Subscribe to location (auth)
- `GET /history` - Alert history (auth)

### Village Weather (`/api/village-weather`)
- `GET /search?q=` - Search villages
- `GET /current?lat=&lon=` - Current weather
- `GET /forecast?lat=&lon=` - Multi-day forecast
- `GET /crop-calendar?lat=&lon=` - Seasonal calendar
- `GET /my-villages` - Saved villages (auth)
- `POST /my-villages` - Save village (auth)

### Market Prices (`/api/market-prices`)
- `GET /msp` - MSP prices for all crops
- `GET /msp/:crop` - MSP for specific crop
- `GET /mandi?state=&commodity=` - Mandi prices
- `GET /trends/:commodity` - Price trends
- `POST /alerts` - Create price alert (auth)

### Schemes (`/api/schemes`)
- `GET /` - All schemes (with filters)
- `GET /:id` - Scheme details
- `POST /:id/check-eligibility` - Check eligibility (auth)
- `POST /:id/subscribe` - Subscribe to updates (auth)

### Auth (`/api/auth`)
- `POST /google` - Google OAuth login
- `POST /facebook` - Facebook OAuth login
- `GET /providers` - Available auth providers

### Consultations (`/api/consultations`)
- `POST /:id/confirm` - Expert confirms booking
- `POST /:id/reject` - Expert rejects booking
- `GET /:id/video-token` - Get Agora video token

---

## Troubleshooting

### Backend won't start
- Check DATABASE_URL is set correctly
- Ensure migrations ran: check build logs
- Verify JWT_SECRET is set

### Social login fails
- Verify OAuth client IDs match platform (web/iOS/Android)
- Check callback URLs in Google/Facebook console
- Ensure HTTPS is used in production

### Weather alerts not working
- Check OPENWEATHER_API_KEY is valid
- Verify user has subscriptions created
- Check logs for API errors

### Video calls fail
- Verify AGORA_APP_ID and AGORA_APP_CERTIFICATE
- Check Agora console for token settings
- Ensure app has camera/microphone permissions

### Database seed fails
- Run migrations first: `npm run migrate:up`
- Check database connection
- View logs for specific errors

---

## Post-Deployment Checklist

- [ ] Backend health check passes
- [ ] Database migrations complete
- [ ] Seed data loaded (schemes, MSP)
- [ ] Frontend deployed and API connected
- [ ] Social login working (Google/Facebook)
- [ ] Weather alerts endpoint returns data
- [ ] Village search returns results
- [ ] Mandi prices API responds
- [ ] Flutter APK built successfully
- [ ] Sentry receiving errors (test with intentional error)

---

## Next Steps

1. **Configure real API keys** in production
2. **Set up Agora** for video consultations
3. **Configure Firebase** for push notifications
4. **Submit to Play Store** (internal testing track)
5. **Monitor Sentry** for production errors
6. **Set up alerts** in Render for service health

---

## Support

- GitHub Issues: https://github.com/your-repo/issues
- Documentation: See `docs/` directory
- API Docs: `https://your-backend.onrender.com/api-docs` (when enabled)
