name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: true
      deploy_backend:
        description: 'Deploy backend to Render'
        type: boolean
        default: true
      deploy_android:
        description: 'Build and upload Android'
        type: boolean
        default: true
      deploy_ios:
        description: 'Build and upload iOS'
        type: boolean
        default: true

env:
  FLUTTER_VERSION: '3.27.1'
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  # Version validation
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Deploying version $VERSION (build $BUILD_NUMBER)"

  # Backend Tests
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: kheti_sahayak_backend/package-lock.json

      - name: Install dependencies
        working-directory: kheti_sahayak_backend
        run: npm ci

      - name: Run tests
        working-directory: kheti_sahayak_backend
        run: npm test

      - name: Run linter
        working-directory: kheti_sahayak_backend
        run: npm run lint || true

  # Flutter Tests
  test-flutter:
    name: Test Flutter App
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: kheti_sahayak_app
        run: flutter pub get

      - name: Analyze code
        working-directory: kheti_sahayak_app
        run: flutter analyze

      - name: Run tests
        working-directory: kheti_sahayak_app
        run: flutter test

  # Deploy Backend to Render
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: [validate, test-backend]
    if: github.event.inputs.deploy_backend != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Trigger Render Deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}"

      - name: Wait for deployment
        run: sleep 120

      - name: Verify deployment
        run: |
          curl -f https://kheti-sahayak-api.onrender.com/api/health || exit 1

  # Build Android AAB
  build-android:
    name: Build Android AAB
    runs-on: ubuntu-latest
    needs: [validate, test-flutter]
    if: github.event.inputs.deploy_android != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Decode Android keystore
        working-directory: kheti_sahayak_app/android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > app/upload-keystore.jks

      - name: Create key.properties
        working-directory: kheti_sahayak_app/android
        run: |
          cat > key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=upload
          storeFile=app/upload-keystore.jks
          EOF

      - name: Get Flutter dependencies
        working-directory: kheti_sahayak_app
        run: flutter pub get

      - name: Build AAB
        working-directory: kheti_sahayak_app
        run: |
          flutter build appbundle \
            --release \
            --build-number=${{ needs.validate.outputs.build_number }} \
            --build-name=${{ needs.validate.outputs.version }}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v6
        with:
          name: android-aab
          path: kheti_sahayak_app/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload to Play Store (Internal Testing)
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
          packageName: com.khetisahayak.app
          releaseFiles: kheti_sahayak_app/build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          inAppUpdatePriority: 2
          changesNotSentForReview: false

  # Build iOS IPA
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    needs: [validate, test-flutter]
    if: github.event.inputs.deploy_ios != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Apple Certificate
        run: |
          # Create temporary keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 -d > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 -d > \
            ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Get Flutter dependencies
        working-directory: kheti_sahayak_app
        run: flutter pub get

      - name: Install CocoaPods
        working-directory: kheti_sahayak_app/ios
        run: pod install

      - name: Build IPA
        working-directory: kheti_sahayak_app
        run: |
          flutter build ipa \
            --release \
            --export-options-plist=ios/ExportOptions.plist \
            --build-number=${{ needs.validate.outputs.build_number }} \
            --build-name=${{ needs.validate.outputs.version }}

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v6
        with:
          name: ios-ipa
          path: kheti_sahayak_app/build/ios/ipa/*.ipa
          retention-days: 30

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: kheti_sahayak_app/build/ios/ipa/kheti_sahayak_app.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

  # Post-deployment validation
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, build-android, build-ios]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "Deployment Status Summary:"
          echo "=========================="
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Android: ${{ needs.build-android.result }}"
          echo "iOS: ${{ needs.build-ios.result }}"

      - name: Verify backend health
        if: needs.deploy-backend.result == 'success'
        run: |
          curl -f https://kheti-sahayak-api.onrender.com/api/health
          echo "✅ Backend is healthy"

      - name: Send Slack notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi

          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "Kheti Sahayak Deployment - ${{ needs.validate.outputs.version }}",
                "fields": [
                  {
                    "title": "Backend",
                    "value": "${{ needs.deploy-backend.result }}",
                    "short": true
                  },
                  {
                    "title": "Android",
                    "value": "${{ needs.build-android.result }}",
                    "short": true
                  },
                  {
                    "title": "iOS",
                    "value": "${{ needs.build-ios.result }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "${{ needs.validate.outputs.version }} (Build ${{ needs.validate.outputs.build_number }})",
                    "short": false
                  }
                ]
              }]
            }' || echo "Slack notification failed"

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build-android, build-ios]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download Android AAB
        uses: actions/download-artifact@v7
        with:
          name: android-aab
          path: ./artifacts

      - name: Download iOS IPA
        uses: actions/download-artifact@v7
        with:
          name: ios-ipa
          path: ./artifacts

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          # Kheti Sahayak v${{ needs.validate.outputs.version }}

          ## What's New
          - Bug fixes and performance improvements
          - Enhanced treatment recommendations
          - Improved UI/UX

          ## Deployment Status
          - ✅ Backend deployed to Render
          - ✅ Android AAB uploaded to Play Store (Internal Testing)
          - ✅ iOS IPA uploaded to TestFlight

          ## Downloads
          Builds are available as artifacts in this release.

          ## Installation
          - **Android**: Download from Play Store (internal testing) or sideload the AAB
          - **iOS**: Join TestFlight beta or download from App Store (after review)

          ## Changelog
          See full changelog at: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            ./artifacts/app-release.aab
            ./artifacts/*.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
