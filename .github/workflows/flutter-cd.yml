name: Flutter CD - Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: kheti_sahayak_app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          echo "API_BASE_URL=${{ secrets.PROD_API_BASE_URL || 'https://api.khetisahayak.com/api' }}" > lib/.env

      - name: Run tests
        run: flutter test

      - name: Build Release APK
        run: |
          flutter build apk --release \
            --build-name=${{ steps.version.outputs.version }} \
            --build-number=${{ github.run_number }}

      - name: Build App Bundle (AAB)
        run: |
          flutter build appbundle --release \
            --build-name=${{ steps.version.outputs.version }} \
            --build-number=${{ github.run_number }}

      - name: Rename artifacts
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/kheti-sahayak-${{ steps.version.outputs.version }}.apk
          mv build/app/outputs/bundle/release/app-release.aab \
             build/app/outputs/bundle/release/kheti-sahayak-${{ steps.version.outputs.version }}.aab

      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "HEAD~10")..HEAD --pretty=format:"- %s" >> RELEASE_NOTES.md || echo "- Initial release" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Downloads" >> RELEASE_NOTES.md
          echo "- **APK**: Direct installation for Android devices" >> RELEASE_NOTES.md
          echo "- **AAB**: App Bundle for Google Play Store" >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Kheti Sahayak ${{ steps.version.outputs.tag }}
          body_path: kheti_sahayak_app/RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            kheti_sahayak_app/build/app/outputs/flutter-apk/kheti-sahayak-${{ steps.version.outputs.version }}.apk
            kheti_sahayak_app/build/app/outputs/bundle/release/kheti-sahayak-${{ steps.version.outputs.version }}.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    name: Build iOS (No Signing)
    runs-on: macos-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    defaults:
      run:
        working-directory: kheti_sahayak_app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          echo "API_BASE_URL=${{ secrets.PROD_API_BASE_URL || 'https://api.khetisahayak.com/api' }}" > lib/.env

      - name: Build iOS (No codesign)
        run: flutter build ios --release --no-codesign

      - name: Archive iOS build
        run: |
          cd build/ios/iphoneos
          zip -r ../../../kheti-sahayak-ios-${{ steps.version.outputs.version }}.zip Runner.app

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: kheti_sahayak_app/kheti-sahayak-ios-${{ steps.version.outputs.version }}.zip
          retention-days: 30

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success()

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        run: |
          echo "Release ${{ steps.version.outputs.version }} published successfully!"
          echo "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
